<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUYDOR - Aplikasi E-commerce</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
    font-family: 'Poppins', sans-serif;
    padding-bottom: 70px;
    background-color: #F3E8FF; /* Light purple background */
    transition: background-color 0.3s ease;
}

/* --- Logo Styling --- */
.buydor-logo {
    font-family: 'Montserrat', sans-serif;
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(90deg, #6D28D9, #A78BFA);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-fill-color: transparent;
    transition: transform 0.3s ease, opacity 0.3s ease;
    display: inline-block;
}
.buydor-logo:hover {
    transform: scale(1.05);
    opacity: 0.9;
}

/* --- Sidebar (Desktop) --- */
.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 250px;
    background: linear-gradient(180deg, #6D28D9 0%, #4C1D95 100%); /* Purple gradient */
    box-shadow: 2px 0 5px rgba(0,0,0,0.2);
    padding-top: 1rem;
    z-index: 1030;
    transition: transform 0.3s ease;
}
.sidebar .nav-link {
    color: #E9D5FF; /* Light purple text */
    padding: 0.8rem 1.5rem;
    display: flex;
    align-items: center;
    transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
    border-radius: 0.375rem;
    margin: 0.2rem 0.5rem;
}
.sidebar .nav-link i {
    margin-right: 0.8rem;
    font-size: 1.2rem;
    transition: transform 0.2s ease;
}
.sidebar .nav-link:hover {
    background-color: #A78BFA; /* Light purple hover */
    color: #fff;
    transform: translateX(5px);
}
.sidebar .nav-link:hover i {
    transform: scale(1.1);
}
.sidebar .nav-link.active {
    background-color: #A78BFA;
    color: #fff;
    font-weight: 600;
}
.sidebar .nav-link.active i {
    transform: scale(1.1);
}

/* --- Main Content Area --- */
.main-content {
    transition: margin-left 0.3s ease;
    padding: 1.5rem;
}

/* --- Bottom Navigation (Mobile) --- */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    z-index: 1030;
    height: 65px;
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
}
.bottom-nav .nav-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 0.7rem;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    transition: color 0.2s ease, transform 0.2s ease;
    position: relative;
}
.bottom-nav .nav-link i {
    font-size: 1.5rem;
    margin-bottom: 0.2rem;
}
.bottom-nav .nav-link:active {
    transform: scale(0.95);
}
.bottom-nav .nav-link.active {
    color: #6D28D9; /* Deep purple */
    font-weight: 600;
}
.bottom-nav .nav-item.center-item .nav-link {
    transform: translateY(-15px);
    background-color: #6D28D9;
    color: #fff;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    box-shadow: 0 0 15px rgba(109, 40, 217, 0.5);
    animation: subtleGlow 2s infinite ease-in-out;
}
.bottom-nav .nav-item.center-item .nav-link.active {
    color: #fff;
}
.bottom-nav .nav-item.center-item .nav-link i {
    font-size: 1.8rem;
}
.bottom-nav .nav-item.center-item .nav-link span {
    position: absolute;
    bottom: -15px;
    font-size: 0.7rem;
    color: #6c757d;
}
.bottom-nav .nav-item.center-item .nav-link.active span {
    color: #6D28D9;
    font-weight: 600;
}

@keyframes subtleGlow {
    0%, 100% { box-shadow: 0 0 10px rgba(109, 40, 217, 0.4); }
    50% { box-shadow: 0 0 20px rgba(109, 40, 217, 0.7); }
}

/* --- Search Bar --- */
.search-bar .form-control {
    padding-left: 2.5rem;
    border-radius: 50rem;
    border: 1px solid #A78BFA;
    background-color: #EDE9FE; /* Light purple input */
}
.search-bar .search-icon {
    position: absolute;
    left: 0.8rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6D28D9;
}

/* --- Product Card Styling --- */
.product-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    border-radius: 0.75rem;
    overflow: hidden;
    background-color: #fff;
}
.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(109, 40, 217, 0.2);
}
.product-card .card-img-top {
    aspect-ratio: 1 / 1;
    object-fit: cover;
    transition: transform 0.3s ease;
}
.product-card:hover .card-img-top {
    transform: scale(1.03);
}
.product-card .badge {
    position: absolute;
    top: 0.8rem;
    left: 0.8rem;
    font-size: 0.7rem;
    padding: 0.4em 0.6em;
    background-color: #DC2626; /* Red badge for contrast */
}
.product-card .favorite-icon {
    position: absolute;
    top: 0.8rem;
    right: 0.8rem;
    font-size: 1.2rem;
    color: rgba(0,0,0, 0.3);
    cursor: pointer;
    transition: color 0.2s ease, transform 0.2s ease;
}
.product-card .favorite-icon.favorited {
    color: #DC2626;
    transform: scale(1.1);
}
.product-card .favorite-icon:hover {
    transform: scale(1.2);
}
.product-card .price-original {
    text-decoration: line-through;
    color: #6c757d;
    font-size: 0.8rem;
    margin-left: 0.5rem;
}
.product-card .btn {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 50rem;
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
}
.product-card .btn-primary {
    background-color: #6D28D9;
    border-color: #6D28D9;
}
.product-card .btn-primary:hover {
    background-color: #5B21B6;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.product-card .star-rating i {
    color: #FBBF24; /* Amber for stars */
}

/* --- Category Pills --- */
.category-nav .nav-link {
    border-radius: 50rem;
    margin: 0 0.3rem;
    transition: background-color 0.3s ease, color 0.3s ease;
    color: #6D28D9;
    background-color: #EDE9FE;
}
.category-nav .nav-link.active {
    background-color: #6D28D9;
    color: #fff;
}

/* --- General Transitions --- */
.fade-in {
    animation: fadeInAnimation 0.5s ease-in forwards;
    opacity: 0;
}
.slide-in-left {
    animation: slideInLeftAnimation 0.5s ease-out forwards;
    opacity: 0;
}
.slide-in-right {
    animation: slideInRightAnimation 0.5s ease-out forwards;
    opacity: 0;
}
.scale-up {
    animation: scaleUpAnimation 0.3s ease-out forwards;
}

@keyframes fadeInAnimation { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideInLeftAnimation { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
@keyframes slideInRightAnimation { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
@keyframes scaleUpAnimation { from { transform: scale(0.9); } to { transform: scale(1); } }

/* --- Responsiveness --- */
@media (max-width: 767.98px) {
    .sidebar { display: none; }
    .main-content { margin-left: 0; }
    .top-search-bar { display: none; }
    body { padding-bottom: 65px; }
}
@media (min-width: 768px) {
    .bottom-nav { display: none; }
    .main-content { margin-left: 250px; }
    body { padding-bottom: 0; }
}

/* --- Checkout Steps --- */
.checkout-step {
    display: none;
    animation: fadeInAnimation 0.5s ease-in forwards;
    background-color: #fff;
    padding: 1.5rem;
    border-radius: 0.75rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.checkout-step.active { display: block; }

/* --- Buttons --- */
.btn-primary {
    background-color: #6D28D9;
    border-color: #6D28D9;
}
.btn-primary:hover {
    background-color: #5B21B6;
    border-color: #5B21B6;
}
.btn-success {
    background-color: #10B981;
    border-color: #10B981;
}
.btn-success:hover {
    background-color: #059669;
    border-color: #059669;
}

/* --- Loading Spinner --- */
#loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.7);
    z-index: 1060;
    display: flex;
    justify-content: center;
    align-items: center;
}
.spinner-border {
    color: #6D28D9;
}

/* --- Placeholder Content --- */
.placeholder-content {
    min-height: 300px;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    background-color: #EDE9FE;
    border-radius: 0.5rem;
    color: #6D28D9;
}
.product-card {
    max-width: 200px; /* Limit card width */
    margin: 0 auto;
}
.product-card .card-img-top {
    height: 120px; /* Smaller image height */
    object-fit: cover;
}
.product-card .card-body {
    padding: 0.75rem;
}
.product-card .card-title {
    font-size: 0.85rem;
    line-height: 1.2;
}
.product-card .price {
    font-size: 0.8rem;
}
.product-card .btn-sm {
    padding: 0.3rem 0.6rem;
    font-size: 0.75rem;
}
.payment-form {
    padding: 1rem;
    border: 1px solid #A78BFA;
    border-radius: 0.5rem;
    background-color: #EDE9FE;
}
.payment-form .form-control,
.payment-form .form-select {
    border-color: #A78BFA;
}
.payment-form .form-label {
    color: #6D28D9;
}
.form-check-input:checked {
    background-color: #6D28D9;
    border-color: #6D28D9;
}
.account-update-form .form-control,
.account-update-form .form-select {
    border-color: #A78BFA;
}
.account-update-form .form-label {
    color: #6D28D9;
}
.img-thumbnail.rounded-circle {
    border: 2px solid #A78BFA;
}
    </style>
</head>
<body>

    <div id="loading-overlay" class="d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Memuat...</span>
        </div>
    </div>

    <nav class="sidebar d-none d-md-block">
        <div class="text-center mb-4">
            <a class="navbar-brand buydor-logo" href="#dashboard">BUYDOR</a>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#dashboard" data-page="dashboard"><i class="bi bi-bag"></i> Shopee</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#cart" data-page="cart"><i class="bi bi-cart-fill"></i> Keranjang <span class="badge bg-danger ms-auto" id="cart-count-sidebar">0</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#favorites" data-page="favorites"><i class="bi bi-heart-fill"></i> Favorit</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#orders" data-page="orders"><i class="bi bi-box-seam-fill"></i> Pesanan</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#account" data-page="account"><i class="bi bi-person-circle"></i> Akun</a>
            </li>
             <li class="nav-item mt-auto mb-3 mx-3">
                 <button class="btn btn-outline-danger w-100 d-none" id="logout-button-sidebar"><i class="bi bi-box-arrow-left"></i> Keluar</button>
             </li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="row mb-4 d-none d-md-flex top-search-bar">
            <div class="col">
                <div class="search-bar">
                    <i class="bi bi-search search-icon"></i>
                    <input type="search" class="form-control" placeholder="Cari produk..." id="search-input-desktop">
                </div>
                <div id="search-results-desktop" class="list-group mt-2 position-absolute w-100" style="z-index: 1000;">
                    </div>
            </div>
        </div>

        <div id="page-content">
            </div>
    </main>

    <nav class="bottom-nav d-md-none">
        <div class="d-flex justify-content-around h-100 align-items-center">
            <div class="nav-item">
                <a class="nav-link" href="#favorites" data-page="favorites"><i class="bi bi-heart"></i><span>Favorit</span></a>
            </div>
            <div class="nav-item">
                <a class="nav-link" href="#cart" data-page="cart"><i class="bi bi-cart"></i><span>Keranjang</span> <span class="badge bg-danger position-absolute top-0 start-100 translate-middle d-none" id="cart-count-mobile">0</span></a>
            </div>
            <div class="nav-item center-item">
                <a class="nav-link active" href="#dashboard" data-page="dashboard"><i class="bi bi-bag"></i><span>Shopee</span></a>
            </div>
            <div class="nav-item">
                <a class="nav-link" href="#orders" data-page="orders"><i class="bi bi-box-seam"></i><span>Pesanan</span></a>
            </div>
            <div class="nav-item">
                <a class="nav-link" href="#account" data-page="account"><i class="bi bi-person"></i><span>Akun</span></a>
            </div>
        </div>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAaIpoN0E5ZiwpzcS9BXEhX11EM7E8ppvg", // Ganti dengan API Key Anda
            authDomain: "personal-7c7a3.firebaseapp.com", // Ganti dengan Auth Domain Anda
            projectId: "personal-7c7a3", // Ganti dengan Project ID Anda
            storageBucket: "personal-7c7a3.appspot.com", // Ganti dengan Storage Bucket Anda
            messagingSenderId: "946750070678", // Ganti dengan Messaging Sender ID Anda
            appId: "1:946750070678:web:c1b4cd4c3626f39f1807b7", // Ganti dengan App ID Anda
            measurementId: "G-XDTL4DNQMG" // Ganti dengan Measurement ID Anda (opsional)
        };

        // --- Initialize Firebase ---
        let app, auth, db, storage, analytics;
        let currentUser = null; // Menyimpan informasi pengguna yang sedang login

        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            if (firebaseConfig.measurementId) {
                analytics = firebase.analytics();
            }
            console.log("Firebase Initialized Successfully");
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            alert("Gagal menginisialisasi aplikasi. Silakan coba lagi nanti.");
        }

        // --- PENANGANAN ERROR FIREBASE ---
        // Jika Anda mendapatkan error "permission-denied" saat mengakses Firestore:
        // Ini berarti Aturan Keamanan (Security Rules) Firestore Anda perlu diperbarui.
        // Buka Firebase Console > Firestore Database > Rules.
        // Ganti aturan default dengan aturan yang lebih permisif (tapi tetap aman).
        //
        // CONTOH ATURAN KEAMANAN (Salin dan tempel di Firebase Console):
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {

            // Izinkan siapa saja membaca koleksi produk
            match /products/{productId} {
              allow read: if true;
              // Hanya admin (contoh) yang bisa menulis produk (implementasi peran admin diperlukan)
              // allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
              allow write: if false; // Sementara nonaktifkan penulisan produk dari klien
            }

            // Izinkan pengguna yang login untuk membaca dan menulis data mereka sendiri
            match /users/{userId} {
              allow read, update, delete: if request.auth != null && request.auth.uid == userId;
              // Izinkan pengguna baru untuk membuat dokumen mereka sendiri setelah registrasi
              allow create: if request.auth != null && request.auth.uid == userId;
            }

            // Izinkan pengguna yang login untuk membaca dan menulis pesanan mereka sendiri
            match /orders/{orderId} {
               allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
               // Izinkan pengguna yang login untuk membuat pesanan baru
               allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
            }

            // (Contoh untuk Ulasan - sesuaikan jika struktur berbeda)
            // match /reviews/{reviewId} {
            //   allow read: if true; // Izinkan siapa saja membaca ulasan
            //   allow create: if request.auth != null; // Izinkan pengguna login membuat ulasan
            //   allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId; // Hanya pembuat ulasan yang bisa edit/hapus
            // }
          }
        }
        */
        // Setelah memperbarui aturan, tunggu beberapa saat dan coba lagi.
        //------------------------------------

        // --- DOM Elements ---
        const pageContent = document.getElementById('page-content');
        const sidebarNavLinks = document.querySelectorAll('.sidebar .nav-link[data-page]');
        const bottomNavLinks = document.querySelectorAll('.bottom-nav .nav-link[data-page]');
        const loadingOverlay = document.getElementById('loading-overlay');
        const cartCountSidebar = document.getElementById('cart-count-sidebar');
        const cartCountMobile = document.getElementById('cart-count-mobile');
        const searchInputDesktop = document.getElementById('search-input-desktop');
        const searchResultsDesktop = document.getElementById('search-results-desktop');
        const logoutButtonSidebar = document.getElementById('logout-button-sidebar');

        // --- Global State ---
        let currentCart = {};
        let currentFavorites = [];

        // --- Utility Functions ---
        const showLoading = () => loadingOverlay.classList.remove('d-none');
        const hideLoading = () => loadingOverlay.classList.add('d-none');

        const updateCartCount = () => {
            const count = Object.values(currentCart).reduce((sum, qty) => sum + qty, 0);
            if (cartCountSidebar) cartCountSidebar.textContent = count;
            if (cartCountMobile) cartCountMobile.textContent = count;
            if (cartCountMobile) cartCountMobile.classList.toggle('d-none', count === 0);
        };

        // --- Page Loading / Routing ---
        const loadPage = (pageId) => {
            console.log(`Loading page: ${pageId}`);
            showLoading();
            sidebarNavLinks.forEach(link => link.classList.remove('active'));
            bottomNavLinks.forEach(link => link.classList.remove('active'));

            const activeSidebarLink = document.querySelector(`.sidebar .nav-link[data-page="${pageId}"]`);
            const activeBottomLink = document.querySelector(`.bottom-nav .nav-link[data-page="${pageId}"]`);
            if (activeSidebarLink) activeSidebarLink.classList.add('active');
            if (activeBottomLink) activeBottomLink.classList.add('active');

            pageContent.innerHTML = ''; // Kosongkan konten sebelum memuat yang baru

            switch (pageId) {
                case 'dashboard': loadDashboardPage(); break;
                case 'cart': loadCartPage(); break;
                case 'favorites': loadFavoritesPage(); break;
                case 'orders': loadOrdersPage(); break;
                case 'account': loadAccountPage(); break;
                case 'checkout': loadCheckoutPage(); break;
                case 'login': loadLoginPage(); break;
                case 'product-detail':
                    pageContent.innerHTML = `<div class="placeholder-content"><h2>Halaman Detail Produk</h2><p>Konten detail produk akan muncul di sini.</p></div>`;
                    hideLoading(); // Sembunyikan loading untuk halaman placeholder
                    break;
                default:
                    pageContent.innerHTML = `<div class="alert alert-warning">Halaman tidak ditemukan: ${pageId}</div>`;
                    hideLoading(); // Sembunyikan loading untuk halaman tidak ditemukan
            }
            // Jangan panggil hideLoading() di sini jika fungsi load...Page bersifat async
        };

        // --- Page Rendering Functions ---
        const loadDashboardPage = async () => {
            let productsHtml = '<div class="row g-3 product-list-row">'; // Tambahkan kelas untuk target filter
            try {
                const categories = ['Elektronik', 'Pakaian', 'Makanan', 'Produk Digital', 'Lainnya'];
                let categoryHtml = `
                    <div class="col-12 mb-3">
                        <nav class="nav nav-pills flex-nowrap overflow-auto category-nav">
                            <a class="nav-link active" href="#" data-category="all">Semua</a>
                            ${categories.map(cat => `<a class="nav-link" href="#" data-category="${cat}">${cat}</a>`).join('')}
                        </nav>
                    </div>`;

                const productsSnapshot = await db.collection('products').limit(10).get();

                if (productsSnapshot.empty) {
                    productsHtml += '<div class="col-12"><p>Belum ada produk.</p></div>';
                } else {
                    productsSnapshot.forEach(doc => {
                        productsHtml += renderProductCard(doc.id, doc.data()); // Gunakan fungsi render terpisah
                    });
                }
                productsHtml += '</div>';
                pageContent.innerHTML = categoryHtml + productsHtml;
                addDashboardEventListeners();
            } catch (error) {
                console.error("Error loading dashboard:", error);
                // Tampilkan pesan error yang lebih informatif jika permission denied
                if (error.code === 'permission-denied') {
                     pageContent.innerHTML = `<div class="alert alert-danger">Gagal memuat produk: Masalah izin akses Firestore. Pastikan Aturan Keamanan (Security Rules) di Firebase Console Anda mengizinkan pembacaan data produk. Lihat komentar di kode JS untuk contoh aturan.</div>`;
                } else {
                     pageContent.innerHTML = `<div class="alert alert-danger">Gagal memuat produk. Silakan coba lagi. Error: ${error.message}</div>`;
                }
            } finally {
                hideLoading();
            }
        };

        const renderProductCard = (productId, product) => {
    const isFavorited = currentFavorites.includes(productId);
    const discountBadge = product.discountPercentage ? `<span class="badge bg-danger">${product.discountPercentage}% OFF</span>` : '';
    const originalPrice = product.discountPercentage ? `<span class="price-original">Rp ${product.originalPrice?.toLocaleString('id-ID') || ''}</span>` : '';
    return `
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 fade-in"> <!-- Smaller columns -->
            <div class="card product-card h-100">
                <img src="${product.imageUrl || 'https://placehold.co/300x300/e9ecef/6c757d?text=Produk'}" class="card-img-top" alt="${product.name}" loading="lazy" onerror="this.onerror=null; this.src='https://placehold.co/300x300/e9ecef/6c757d?text=Gagal+Muat';">
                ${discountBadge}
                <i class="bi ${isFavorited ? 'bi-heart-fill' : 'bi-heart'} favorite-icon ${isFavorited ? 'favorited' : ''}" data-product-id="${productId}"></i>
                <div class="card-body d-flex flex-column p-2"> <!-- Reduced padding -->
                    <h5 class="card-title fs-6 mb-1">${product.name || 'Nama Produk'}</h5>
                    <p class="card-text price mb-1">
                        <span class="fw-bold fs-6 text-primary">Rp ${product.price?.toLocaleString('id-ID') || 'N/A'}</span>
                        ${originalPrice}
                    </p>
                    <div class="star-rating mb-2">
                        ${generateStarRating(product.averageRating || 0)} <span class="ms-1 text-muted small">(${product.reviewCount || 0})</span>
                    </div>
                    <div class="mt-auto d-flex gap-1 justify-content-between">
                        <button class="btn btn-primary btn-sm add-to-cart-btn" data-product-id="${productId}"><i class="bi bi-cart-plus"></i></button>
                        <button class="btn btn-outline-secondary btn-sm buy-now-btn" data-product-id="${productId}"><i class="bi bi-bag-check"></i></button>
                        <button class="btn btn-outline-info btn-sm share-btn" data-product-id="${productId}" data-product-name="${product.name}"><i class="bi bi-share"></i></button>
                    </div>
                </div>
            </div>
        </div>`;
};


        const loadCartPage = async () => {
             showLoading();
             let cartHtml = `<h2><i class="bi bi-cart-fill me-2"></i>Keranjang Belanja Anda</h2>`;
             if (!currentUser) {
                 cartHtml += `<div class="alert alert-warning">Silakan <a href="#login" onclick="loadPage('login'); return false;">login</a> untuk melihat keranjang Anda.</div>`;
                 pageContent.innerHTML = cartHtml;
                 hideLoading();
                 return;
             }

             if (Object.keys(currentCart).length === 0) {
                 cartHtml += `<div class="placeholder-content text-center fade-in"><i class="bi bi-cart-x fs-1 mb-3"></i><p>Keranjang Anda kosong.</p><a href="#dashboard" onclick="loadPage('dashboard'); return false;" class="btn btn-primary">Mulai Belanja</a></div>`;
                 pageContent.innerHTML = cartHtml;
                 hideLoading();
                 return;
             }

             cartHtml += `<div class="list-group mb-4 fade-in">`;
             let totalPrice = 0;
             const productIds = Object.keys(currentCart);
             // Hindari error jika productIds kosong
             if (productIds.length === 0) {
                  loadCartPage(); // Muat ulang halaman keranjang (akan menampilkan pesan kosong)
                  return;
             }
             const productPromises = productIds.map(id => db.collection('products').doc(id).get());

             try {
                 const productDocs = await Promise.all(productPromises);
                 let itemsRendered = 0;
                 productDocs.forEach(doc => {
                     if (doc.exists) {
                         itemsRendered++;
                         const product = doc.data();
                         const productId = doc.id;
                         const quantity = currentCart[productId];
                         // Pastikan quantity valid
                         if (!quantity || quantity < 1) {
                             delete currentCart[productId];
                             updateUserCartInFirestore();
                             return; // Lewati item ini
                         }
                         const itemTotal = (product.price || 0) * quantity;
                         totalPrice += itemTotal;

                         cartHtml += `
                             <div class="list-group-item d-flex align-items-center cart-item slide-in-left" data-product-id="${productId}">
                                 <img src="${product.imageUrl || 'https://placehold.co/100x100/e9ecef/6c757d?text=Produk'}" alt="${product.name}" width="80" class="me-3 rounded">
                                 <div class="flex-grow-1">
                                     <h6 class="mb-1">${product.name || 'Nama Produk'}</h6>
                                     <p class="mb-1 text-muted">Rp ${product.price?.toLocaleString('id-ID') || 'N/A'}</p>
                                     <div class="input-group input-group-sm" style="max-width: 120px;">
                                         <button class="btn btn-outline-secondary quantity-change-btn" type="button" data-change="-1">-</button>
                                         <input type="number" class="form-control text-center quantity-input" value="${quantity}" min="1" readonly>
                                         <button class="btn btn-outline-secondary quantity-change-btn" type="button" data-change="1">+</button>
                                     </div>
                                 </div>
                                 <div class="text-end ms-3">
                                     <p class="fw-bold mb-1">Rp ${itemTotal.toLocaleString('id-ID')}</p>
                                     <button class="btn btn-sm btn-outline-danger remove-cart-item-btn"><i class="bi bi-trash"></i></button>
                                 </div>
                             </div>`;
                     } else {
                         console.warn(`Produk dengan ID ${doc.id} tidak ditemukan di database.`);
                         delete currentCart[doc.id];
                         updateUserCartInFirestore();
                     }
                 });

                 // Jika setelah iterasi tidak ada item yang valid, tampilkan pesan kosong
                 if (itemsRendered === 0) {
                     loadCartPage(); // Muat ulang untuk menampilkan pesan keranjang kosong
                     return;
                 }


                 cartHtml += `</div>`;
                 cartHtml += `
                     <div class="card shadow-sm fade-in">
                         <div class="card-body d-flex justify-content-between align-items-center">
                             <div>
                                 <h5 class="mb-0">Total Harga:</h5>
                                 <p class="fw-bold fs-4 text-primary mb-0" id="cart-total-price">Rp ${totalPrice.toLocaleString('id-ID')}</p>
                             </div>
                             <button class="btn btn-success btn-lg scale-up checkout-btn"><i class="bi bi-shield-check me-2"></i>Checkout</button>
                         </div>
                     </div>`;

                 pageContent.innerHTML = cartHtml;
                 addCartEventListeners();
             } catch (error) {
                 console.error("Error loading cart:", error);
                 if (error.code === 'permission-denied') {
                      pageContent.innerHTML = `<div class="alert alert-danger">Gagal memuat keranjang: Masalah izin akses Firestore. Pastikan Aturan Keamanan (Security Rules) di Firebase Console Anda mengizinkan pembacaan data produk.</div>`;
                 } else {
                      pageContent.innerHTML = `<div class="alert alert-danger">Gagal memuat keranjang. Silakan coba lagi. Error: ${error.message}</div>`;
                 }
             } finally {
                 hideLoading();
             }
        };

        const loadFavoritesPage = async () => {
            showLoading();
            let favoritesHtml = `<h2><i class="bi bi-heart-fill me-2 text-danger"></i>Produk Favorit Anda</h2>`;
            if (!currentUser) {
                favoritesHtml += `<div class="alert alert-warning">Silakan <a href="#login" onclick="loadPage('login'); return false;">login</a> untuk melihat favorit Anda.</div>`;
                pageContent.innerHTML = favoritesHtml;
                hideLoading();
                return;
            }

            if (currentFavorites.length === 0) {
                favoritesHtml += `<div class="placeholder-content text-center fade-in"><i class="bi bi-heartbreak fs-1 mb-3"></i><p>Anda belum menambahkan produk favorit.</p><a href="#dashboard" onclick="loadPage('dashboard'); return false;" class="btn btn-primary">Cari Produk</a></div>`;
                pageContent.innerHTML = favoritesHtml;
                hideLoading();
                return;
            }

            favoritesHtml += '<div class="row g-3">';
            const productPromises = currentFavorites.map(id => db.collection('products').doc(id).get());

            try {
                const productDocs = await Promise.all(productPromises);
                let itemsRendered = 0;
                productDocs.forEach(doc => {
                    if (doc.exists) {
                         itemsRendered++;
                         favoritesHtml += renderProductCard(doc.id, doc.data()); // Gunakan fungsi render
                    } else {
                         console.warn(`Produk favorit dengan ID ${doc.id} tidak ditemukan.`);
                         const index = currentFavorites.indexOf(doc.id);
                         if (index > -1) {
                             currentFavorites.splice(index, 1);
                             updateUserFavoritesInFirestore();
                         }
                    }
                });
                 // Jika setelah iterasi tidak ada item yang valid, tampilkan pesan kosong
                 if (itemsRendered === 0) {
                     loadFavoritesPage(); // Muat ulang untuk menampilkan pesan kosong
                     return;
                 }
                favoritesHtml += '</div>';
                pageContent.innerHTML = favoritesHtml;
                addDashboardEventListeners(); // Listener kartu produk sama
            } catch (error) {
                console.error("Error loading favorites:", error);
                 if (error.code === 'permission-denied') {
                      pageContent.innerHTML = `<div class="alert alert-danger">Gagal memuat favorit: Masalah izin akses Firestore. Pastikan Aturan Keamanan (Security Rules) di Firebase Console Anda mengizinkan pembacaan data produk.</div>`;
                 } else {
                      pageContent.innerHTML = `<div class="alert alert-danger">Gagal memuat favorit. Silakan coba lagi. Error: ${error.message}</div>`;
                 }
            } finally {
                hideLoading();
            }
        };

        const loadOrdersPage = async () => {
             showLoading();
             let ordersHtml = `<h2><i class="bi bi-box-seam-fill me-2"></i>Riwayat Pesanan Anda</h2>`;
             if (!currentUser) {
                 ordersHtml += `<div class="alert alert-warning">Silakan <a href="#login" onclick="loadPage('login'); return false;">login</a> untuk melihat riwayat pesanan Anda.</div>`;
                 pageContent.innerHTML = ordersHtml;
                 hideLoading();
                 return;
             }

             try {
                 const ordersSnapshot = await db.collection('orders')
                                             .where('userId', '==', currentUser.uid)
                                             .orderBy('orderDate', 'desc')
                                             .get();

                 if (ordersSnapshot.empty) {
                     ordersHtml += `<div class="placeholder-content text-center fade-in"><i class="bi bi-receipt fs-1 mb-3"></i><p>Anda belum memiliki pesanan.</p><a href="#dashboard" onclick="loadPage('dashboard'); return false;" class="btn btn-primary">Mulai Belanja</a></div>`;
                 } else {
                     ordersHtml += `<div class="list-group fade-in">`;
                     ordersSnapshot.forEach(doc => {
                         const order = doc.data();
                         const orderId = doc.id;
                         const orderDate = order.orderDate?.toDate ? order.orderDate.toDate().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Tanggal tidak diketahui';
                         const status = order.status || 'Tidak diketahui';
                         const progress = getOrderStatusProgress(status);

                         ordersHtml += `
                             <div class="list-group-item list-group-item-action flex-column align-items-start mb-3 shadow-sm rounded slide-in-right">
                                 <div class="d-flex w-100 justify-content-between">
                                     <h5 class="mb-1">Pesanan #${orderId.substring(0, 8)}...</h5>
                                     <small>${orderDate}</small>
                                 </div>
                                 <p class="mb-1">Status: <span class="badge ${getOrderStatusBadgeClass(status)}">${status}</span></p>
                                 <p class="mb-2">Total: <span class="fw-bold">Rp ${order.totalPrice?.toLocaleString('id-ID') || 'N/A'}</span></p>
                                 <div class="progress mb-2" style="height: 10px;">
                                     <div class="progress-bar ${getOrderStatusProgressClass(status)}" role="progressbar" style="width: ${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
                                 </div>
                                 <button class="btn btn-sm btn-outline-primary view-order-details-btn" data-order-id="${orderId}">Lihat Detail</button>
                             </div>`;
                     });
                     ordersHtml += `</div>`;
                 }
                 pageContent.innerHTML = ordersHtml;
                 addOrdersEventListeners();
             } catch (error) {
                 console.error("Error loading orders:", error);
                  if (error.code === 'permission-denied') {
                      pageContent.innerHTML = `<div class="alert alert-danger">Gagal memuat pesanan: Masalah izin akses Firestore. Pastikan Aturan Keamanan (Security Rules) di Firebase Console Anda mengizinkan pembacaan data pesanan milik pengguna.</div>`;
                 } else {
                      pageContent.innerHTML = `<div class="alert alert-danger">Gagal memuat riwayat pesanan. Silakan coba lagi. Error: ${error.message}</div>`;
                 }
             } finally {
                 hideLoading();
             }
        };

        const loadAccountPage = async () => {
    showLoading();
    let accountHtml = `<h2><i class="bi bi-person-circle me-2"></i>Akun Saya</h2>`;
    if (!currentUser) {
        accountHtml += `<div class="alert alert-warning">Silakan <a href="#login" onclick="loadPage('login'); return false;">login</a> untuk melihat detail akun Anda.</div>`;
        pageContent.innerHTML = accountHtml;
        hideLoading();
        return;
    }

    try {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        const userData = doc.exists ? doc.data() : {};
        const displayName = userData.name || currentUser.displayName || 'Pengguna Baru';
        const photoURL = userData.photoURL || currentUser.photoURL || 'https://placehold.co/150x150/e9ecef/6c757d?text=Profil';
        const phoneNumber = userData.phoneNumber || currentUser.phoneNumber || '';
        const address = userData.address || '';

        accountHtml = `
            <div class="row g-4 fade-in">
                <div class="col-md-4 text-center">
                    <div class="position-relative d-inline-block">
                        <img src="${photoURL}" alt="Foto Profil" class="img-thumbnail rounded-circle mb-3" width="150" height="150" id="profile-picture-preview">
                        <button class="btn btn-sm btn-primary position-absolute bottom-0 end-0" onclick="document.getElementById('profile-picture-input').click();" title="Ubah Foto">
                            <i class="bi bi-camera"></i>
                        </button>
                        <input type="file" id="profile-picture-input" accept="image/*" class="d-none">
                    </div>
                </div>
                <div class="col-md-8">
                    <form id="account-update-form">
                        <div class="mb-3">
                            <label for="account-name" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="account-name" value="${displayName}" required>
                        </div>
                        <div class="mb-3">
                            <label for="account-phone" class="form-label">Nomor Telepon</label>
                            <input type="tel" class="form-control" id="account-phone" value="${phoneNumber}">
                        </div>
                        <div class="mb-3">
                            <label for="account-address" class="form-label">Alamat</label>
                            <textarea class="form-control" id="account-address" rows="3">${address}</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="account-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="account-email" value="${currentUser.email || ''}" disabled>
                            <small class="text-muted">Email tidak dapat diubah.</small>
                        </div>
                        <div class="mb-3">
                            <label for="account-password" class="form-label">Ubah Kata Sandi</label>
                            <input type="password" class="form-control" id="account-password" placeholder="Masukkan kata sandi baru (opsional)">
                            <small class="text-muted">Kosongkan jika tidak ingin mengubah kata sandi. Min. 6 karakter.</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary scale-up"><i class="bi bi-save me-1"></i> Simpan</button>
                            <button type="button" class="btn btn-danger scale-up" id="logout-button-account"><i class="bi bi-box-arrow-right me-1"></i> Keluar</button>
                        </div>
                    </form>
                </div>
            </div>`;
        pageContent.innerHTML = accountHtml;
        addAccountEventListeners();
    } catch (error) {
        console.error("Error fetching user data for account page:", error);
        if (error.code === 'permission-denied') {
            pageContent.innerHTML = `<div class="alert alert-danger">Gagal memuat data akun: Masalah izin akses Firestore. Pastikan Aturan Keamanan (Security Rules) di Firebase Console Anda mengizinkan pembacaan data pengguna sendiri.</div>`;
        } else {
            pageContent.innerHTML = `<div class="alert alert-danger">Gagal memuat data akun. Error: ${error.message}</div>`;
        }
    } finally {
        hideLoading();
    }
};


        const loadLoginPage = () => {
            showLoading();
            if (currentUser) {
                loadPage('dashboard');
                return;
            }
            const loginHtml = `
                <div class="row justify-content-center fade-in">
                    <div class="col-md-6 col-lg-5">
                        <div class="card shadow-sm">
                            <div class="card-body p-4">
                                <h2 class="text-center mb-4 buydor-logo">BUYDOR Login</h2>
                                <form id="login-form">
                                    <div class="mb-3">
                                        <label for="login-email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="login-email" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="login-password" class="form-label">Kata Sandi</label>
                                        <input type="password" class="form-control" id="login-password" required>
                                    </div>
                                    <div class="d-grid mb-3">
                                        <button type="submit" class="btn btn-primary btn-lg scale-up">Login</button>
                                    </div>
                                </form>
                                <div class="text-center mb-3">
                                    <small class="text-muted">Atau login dengan</small>
                                </div>
                                <div class="d-grid mb-3">
                                     <button type="button" class="btn btn-outline-danger scale-up" id="google-login-button">
                                         <i class="bi bi-google me-2"></i> Login dengan Google
                                     </button>
                                     </div>
                                <div class="text-center">
                                    <small>Belum punya akun? <a href="#register" id="show-register-link">Daftar di sini</a></small>
                                </div>
                                <div id="login-error" class="alert alert-danger mt-3 d-none"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row justify-content-center mt-4 d-none" id="register-section">
                     <div class="col-md-6 col-lg-5">
                         <div class="card shadow-sm">
                             <div class="card-body p-4">
                                 <h2 class="text-center mb-4">Daftar Akun Baru</h2>
                                 <form id="register-form">
                                     <div class="mb-3">
                                         <label for="register-name" class="form-label">Nama Lengkap</label>
                                         <input type="text" class="form-control" id="register-name" required>
                                     </div>
                                     <div class="mb-3">
                                         <label for="register-email" class="form-label">Email</label>
                                         <input type="email" class="form-control" id="register-email" required>
                                     </div>
                                     <div class="mb-3">
                                         <label for="register-password" class="form-label">Kata Sandi (min. 6 karakter)</label>
                                         <input type="password" class="form-control" id="register-password" required minlength="6">
                                     </div>
                                      <div class="mb-3">
                                         <label for="register-confirm-password" class="form-label">Konfirmasi Kata Sandi</label>
                                         <input type="password" class="form-control" id="register-confirm-password" required>
                                     </div>
                                     <div class="d-grid mb-3">
                                         <button type="submit" class="btn btn-success btn-lg scale-up">Daftar</button>
                                     </div>
                                 </form>
                                 <div class="text-center">
                                     <small>Sudah punya akun? <a href="#login" id="show-login-link">Login di sini</a></small>
                                 </div>
                                  <div id="register-error" class="alert alert-danger mt-3 d-none"></div>
                             </div>
                         </div>
                     </div>
                 </div>
            `;
            pageContent.innerHTML = loginHtml;
            addAuthEventListeners();
            hideLoading();
        };

        const loadCheckoutPage = () => {
    showLoading();
    let checkoutHtml = `<h2><i class="bi bi-shield-check me-2"></i>Checkout</h2>`;
    if (!currentUser) {
        checkoutHtml += `<div class="alert alert-warning">Silakan <a href="#login" onclick="loadPage('login'); return false;">login</a> untuk melanjutkan checkout.</div>`;
        pageContent.innerHTML = checkoutHtml;
        hideLoading();
        return;
    }
    if (Object.keys(currentCart).length === 0) {
        checkoutHtml += `<div class="alert alert-info">Keranjang Anda kosong. Tidak ada yang bisa di-checkout.</div>`;
        pageContent.innerHTML = checkoutHtml;
        hideLoading();
        return;
    }

    checkoutHtml += `
        <div id="checkout-steps" class="fade-in">
            <div id="step-review" class="checkout-step active">
                <h4>Langkah 1: Tinjau Pesanan</h4>
                <div id="checkout-cart-summary" class="mb-3">
                    <p>Memuat ringkasan keranjang...</p>
                </div>
                <button class="btn btn-primary next-step-btn" data-next="step-shipping">Lanjut ke Pengiriman</button>
            </div>

            <div id="step-shipping" class="checkout-step">
                <h4>Langkah 2: Detail Pengiriman</h4>
                <form id="shipping-form">
                    <div class="mb-3">
                        <label for="shipping-name" class="form-label">Nama Penerima</label>
                        <input type="text" class="form-control" id="shipping-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="shipping-address" class="form-label">Alamat Lengkap</label>
                        <textarea class="form-control" id="shipping-address" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="shipping-phone" class="form-label">Nomor Telepon</label>
                        <input type="tel" class="form-control" id="shipping-phone" required>
                    </div>
                    <button type="button" class="btn btn-secondary prev-step-btn" data-prev="step-review">Kembali</button>
                    <button type="submit" class="btn btn-primary next-step-btn" data-next="step-payment">Lanjut ke Pembayaran</button>
                </form>
            </div>

            <div id="step-payment" class="checkout-step">
                <h4>Langkah 3: Metode Pembayaran</h4>
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="payment-cc" value="cc" checked>
                        <label class="form-check-label" for="payment-cc">Kartu Kredit</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="payment-bank" value="bank">
                        <label class="form-check-label" for="payment-bank">Transfer Bank</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="payment-wallet" value="wallet">
                        <label class="form-check-label" for="payment-wallet">Dompet Digital</label>
                    </div>
                </div>

                <!-- Credit Card Form -->
                <div id="cc-form" class="payment-form active">
                    <form id="credit-card-form">
                        <div class="mb-3">
                            <label for="cc-number" class="form-label">Nomor Kartu</label>
                            <input type="text" class="form-control" id="cc-number" placeholder="1234 5678 9012 3456" required maxlength="19" pattern="[0-9\s]{16,19}">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cc-expiry" class="form-label">Tanggal Kadaluarsa</label>
                                <input type="text" class="form-control" id="cc-expiry" placeholder="MM/YY" required pattern="(0[1-9]|1[0-2])/[0-9]{2}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cc-cvv" class="form-label">CVV</label>
                                <input type="text" class="form-control" id="cc-cvv" placeholder="123" required pattern="[0-9]{3,4}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="cc-name" class="form-label">Nama pada Kartu</label>
                            <input type="text" class="form-control" id="cc-name" required>
                        </div>
                    </form>
                </div>

                <!-- Bank Transfer Form -->
                <div id="bank-form" class="payment-form d-none">
                    <form id="bank-transfer-form">
                        <div class="mb-3">
                            <label for="bank-select" class="form-label">Pilih Bank</label>
                            <select class="form-select" id="bank-select" required>
                                <option value="" disabled selected>Pilih bank...</option>
                                <option value="BCA">Bank Central Asia (BCA)</option>
                                <option value="Mandiri">Bank Mandiri</option>
                                <option value="BNI">Bank Negara Indonesia (BNI)</option>
                                <option value="BRI">Bank Rakyat Indonesia (BRI)</option>
                                <option value="Permata">Permata Bank</option>
                            </select>
                        </div>
                        <div class="alert alert-info">
                            Setelah konfirmasi, Anda akan menerima nomor rekening tujuan untuk transfer. Harap lakukan pembayaran dalam 24 jam.
                        </div>
                    </form>
                </div>

                <!-- Digital Wallet Form -->
                <div id="wallet-form" class="payment-form d-none">
                    <form id="digital-wallet-form">
                        <div class="mb-3">
                            <label for="wallet-select" class="form-label">Pilih Dompet Digital</label>
                            <select class="form-select" id="wallet-select" required>
                                <option value="" disabled selected>Pilih dompet digital...</option>
                                <option value="OVO">OVO</option>
                                <option value="DANA">DANA</option>
                                <option value="GoPay">GoPay</option>
                                <option value="ShopeePay">ShopeePay</option>
                                <option value="LinkAja">LinkAja</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="wallet-phone" class="form-label">Nomor Telepon Terkait</label>
                            <input type="tel" class="form-control" id="wallet-phone" placeholder="Masukkan nomor telepon" required>
                        </div>
                        <div class="alert alert-info">
                            Anda akan diarahkan ke aplikasi dompet digital untuk menyelesaikan pembayaran setelah konfirmasi.
                        </div>
                    </form>
                </div>

                <button type="button" class="btn btn-secondary prev-step-btn" data-prev="step-shipping">Kembali</button>
                <button type="button" class="btn btn-success place-order-btn scale-up">Konfirmasi & Bayar</button>
            </div>

            <div id="step-confirmation" class="checkout-step text-center">
                <i class="bi bi-check-circle-fill text-success display-1 mb-3"></i>
                <h4>Pesanan Berhasil Dibuat!</h4>
                <p>Terima kasih telah berbelanja di BUYDOR.</p>
                <p>ID Pesanan Anda: <strong id="confirmation-order-id"></strong></p>
                <p>Anda akan menerima konfirmasi email segera.</p>
                <a href="#orders" onclick="loadPage('orders'); return false;" class="btn btn-primary mt-3">Lihat Riwayat Pesanan</a>
            </div>
        </div>
    `;
    pageContent.innerHTML = checkoutHtml;
    loadCheckoutCartSummary();
    addCheckoutEventListeners();
    hideLoading();
};

        // --- Helper Functions ---
        const generateStarRating = (rating) => {
            let stars = '';
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            for (let i = 0; i < fullStars; i++) stars += '<i class="bi bi-star-fill"></i>';
            if (halfStar) stars += '<i class="bi bi-star-half"></i>';
            for (let i = 0; i < emptyStars; i++) stars += '<i class="bi bi-star"></i>';
            return stars || '<small class="text-muted">Belum ada rating</small>';
        };

        const getOrderStatusProgress = (status) => {
             switch (status?.toLowerCase()) {
                 case 'dalam proses': return 25;
                 case 'dikemas': return 50;
                 case 'dikirim': return 75;
                 case 'diterima': case 'selesai': return 100;
                 case 'dibatalkan': return 0;
                 default: return 10;
             }
         };

         const getOrderStatusBadgeClass = (status) => {
             switch (status?.toLowerCase()) {
                 case 'dalam proses': return 'bg-warning text-dark';
                 case 'dikemas': return 'bg-info text-dark';
                 case 'dikirim': return 'bg-primary';
                 case 'diterima': case 'selesai': return 'bg-success';
                 case 'dibatalkan': return 'bg-danger';
                 default: return 'bg-secondary';
             }
         };

        const getOrderStatusProgressClass = (status) => {
             switch (status?.toLowerCase()) {
                 case 'dalam proses': return 'bg-warning';
                 case 'dikemas': return 'bg-info';
                 case 'dikirim': return 'bg-primary';
                 case 'diterima': case 'selesai': return 'bg-success';
                 case 'dibatalkan': return 'bg-danger';
                 default: return 'bg-secondary';
             }
         };

        const showErrorMessage = (elementId, message) => {
            const errorEl = document.getElementById(elementId);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('d-none');
            }
        };
        const hideErrorMessage = (elementId) => {
             const errorEl = document.getElementById(elementId);
             if (errorEl) {
                 errorEl.classList.add('d-none');
             }
         };

        // --- Firestore Interaction Functions ---
        const fetchUserData = async (userId) => {
            console.log("Fetching user data for:", userId);
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentCart = userData.cart || {};
                    currentFavorites = userData.favorites || [];
                    console.log("User data fetched:", { cart: currentCart, favorites: currentFavorites });
                } else {
                    console.log("No user document found for UID:", userId, "- This might happen right after registration before the document is created.");
                    // Tidak perlu membuat dokumen di sini lagi karena sudah ditangani saat registrasi
                    currentCart = {};
                    currentFavorites = [];
                }
                updateCartCount();
                // Muat halaman awal HANYA jika belum ada konten (mencegah reload saat auth state berubah tapi user sudah di suatu halaman)
                if (!pageContent.hasChildNodes()) {
                    const initialPage = window.location.hash.substring(1) || 'dashboard';
                    loadPage(initialPage);
                } else {
                    hideLoading(); // Sembunyikan loading jika halaman sudah ada
                }

            } catch (error) {
                console.error("Error fetching user data:", error);
                // Tampilkan pesan error spesifik jika permission denied
                if (error.code === 'permission-denied') {
                    pageContent.innerHTML = `<div class="alert alert-danger">Gagal memuat data pengguna: Masalah izin akses Firestore. Pastikan Aturan Keamanan (Security Rules) di Firebase Console Anda mengizinkan pembacaan data pengguna sendiri.</div>`;
                } else {
                    // Handle error lain, mungkin tampilkan pesan umum
                    pageContent.innerHTML = `<div class="alert alert-danger">Terjadi masalah saat memuat data pengguna. Coba refresh halaman.</div>`;
                }
                currentUser = null; // Logout pengguna jika data penting gagal dimuat
                currentCart = {};
                currentFavorites = [];
                updateCartCount();
                hideLoading();
                // Mungkin arahkan ke halaman login jika error parah?
                // loadPage('login');
            }
        };


        const updateUserCartInFirestore = async () => {
             if (!currentUser) return;
             try {
                 await db.collection('users').doc(currentUser.uid).update({
                     cart: currentCart
                 });
                 console.log("Cart updated in Firestore");
             } catch (error) {
                 console.error("Error updating cart in Firestore:", error);
                 // Beri tahu pengguna jika gagal menyimpan keranjang?
                 // alert("Gagal menyimpan perubahan keranjang ke server.");
             }
         };

         const updateUserFavoritesInFirestore = async () => {
             if (!currentUser) return;
             try {
                 await db.collection('users').doc(currentUser.uid).update({
                     favorites: currentFavorites
                 });
                 console.log("Favorites updated in Firestore");
             } catch (error) {
                 console.error("Error updating favorites in Firestore:", error);
                  // Beri tahu pengguna jika gagal menyimpan favorit?
                 // alert("Gagal menyimpan perubahan favorit ke server.");
             }
         };

        // --- Event Listeners Setup ---
        const addNavigationListeners = () => {
            const allNavLinks = [...sidebarNavLinks, ...bottomNavLinks];
            allNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page');
                    if (pageId) {
                        loadPage(pageId);
                    }
                });
            });
        };

        const addAuthEventListeners = () => {
             const loginForm = document.getElementById('login-form');
             if (loginForm) {
                 loginForm.addEventListener('submit', async (e) => {
                     e.preventDefault();
                     showLoading();
                     hideErrorMessage('login-error');
                     const email = document.getElementById('login-email').value;
                     const password = document.getElementById('login-password').value;
                     try {
                         await auth.signInWithEmailAndPassword(email, password);
                         console.log("Login successful via email/password");
                         // onAuthStateChanged akan menangani sisanya
                     } catch (error) {
                         console.error("Login Error:", error);
                         showErrorMessage('login-error', `Login Gagal: ${error.message}`);
                         hideLoading();
                     }
                 });
             }

             const googleLoginButton = document.getElementById('google-login-button');
             if (googleLoginButton) {
                 googleLoginButton.addEventListener('click', async () => {
                     showLoading();
                     hideErrorMessage('login-error');
                     const provider = new firebase.auth.GoogleAuthProvider();
                     try {
                         await auth.signInWithPopup(provider);
                         console.log("Login successful via Google");
                          // onAuthStateChanged akan menangani sisanya
                     } catch (error) {
                         console.error("Google Login Error:", error);
                         // Tampilkan pesan error yang lebih spesifik
                         if (error.code === 'auth/operation-not-supported-in-this-environment') {
                              showErrorMessage('login-error', 'Login Google tidak didukung di lingkungan ini. Pastikan domain Anda diotorisasi di Firebase Console.');
                         } else if (error.code === 'auth/popup-closed-by-user') {
                              showErrorMessage('login-error', 'Login Google dibatalkan.');
                         } else {
                              showErrorMessage('login-error', `Login Google Gagal: ${error.message}`);
                         }
                         hideLoading();
                     }
                 });
             }

             const registerForm = document.getElementById('register-form');
             if (registerForm) {
                 registerForm.addEventListener('submit', async (e) => {
                     e.preventDefault();
                     showLoading();
                     hideErrorMessage('register-error');
                     const name = document.getElementById('register-name').value;
                     const email = document.getElementById('register-email').value;
                     const password = document.getElementById('register-password').value;
                     const confirmPassword = document.getElementById('register-confirm-password').value;

                     if (password !== confirmPassword) {
                         showErrorMessage('register-error', 'Kata sandi dan konfirmasi kata sandi tidak cocok.');
                         hideLoading();
                         return;
                     }
                     if (password.length < 6) {
                          showErrorMessage('register-error', 'Kata sandi minimal harus 6 karakter.');
                          hideLoading();
                          return;
                     }

                     try {
                         const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                         console.log("Firebase Auth user created:", userCredential.user.uid);

                         // Update profile (nama) - ini tidak memerlukan aturan Firestore
                         await userCredential.user.updateProfile({ displayName: name });
                         console.log("Firebase Auth profile updated with name.");

                         // Buat dokumen user di Firestore
                         // Ini memerlukan aturan Firestore yang mengizinkan 'create'
                         await db.collection('users').doc(userCredential.user.uid).set({
                             name: name,
                             email: email,
                             photoURL: null, // Default photoURL
                             createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                             cart: {},
                             favorites: []
                         });
                         console.log("Firestore user document created.");
                         // Registrasi berhasil, onAuthStateChanged akan menangani navigasi
                     } catch (error) {
                         console.error("Registration Error:", error);
                         if (error.code === 'permission-denied') {
                              showErrorMessage('register-error', `Registrasi Gagal: Masalah izin akses Firestore. Aturan Keamanan mungkin tidak mengizinkan pembuatan dokumen pengguna baru. Periksa aturan 'create' untuk /users/{userId}.`);
                         } else if (error.code === 'auth/email-already-in-use') {
                              showErrorMessage('register-error', 'Registrasi Gagal: Alamat email ini sudah digunakan.');
                         } else {
                              showErrorMessage('register-error', `Registrasi Gagal: ${error.message}`);
                         }
                         hideLoading();
                     }
                 });
             }

             const showRegisterLink = document.getElementById('show-register-link');
             const showLoginLink = document.getElementById('show-login-link');
             const registerSection = document.getElementById('register-section');
             const loginCard = loginForm?.closest('.card');

             if (showRegisterLink && registerSection && loginCard) {
                 showRegisterLink.addEventListener('click', (e) => {
                     e.preventDefault();
                     loginCard.parentElement.classList.add('d-none');
                     registerSection.classList.remove('d-none');
                     hideErrorMessage('login-error'); // Sembunyikan error login saat pindah
                 });
             }
             if (showLoginLink && registerSection && loginCard) {
                  showLoginLink.addEventListener('click', (e) => {
                      e.preventDefault();
                      registerSection.classList.add('d-none');
                      loginCard.parentElement.classList.remove('d-none');
                      hideErrorMessage('register-error'); // Sembunyikan error register saat pindah
                  });
             }
         };

        const addDashboardEventListeners = () => {
            const productListContainer = pageContent.querySelector('.product-list-row'); // Target row produk
            if (!productListContainer) return; // Pastikan container ada

             // Gunakan event delegation untuk efisiensi
             productListContainer.addEventListener('click', (e) => {
                 const target = e.target;

                 // Tombol Add to Cart
                 const addToCartBtn = target.closest('.add-to-cart-btn');
                 if (addToCartBtn) {
                      if (!currentUser) {
                         alert("Silakan login untuk menambahkan item ke keranjang.");
                         loadPage('login');
                         return;
                     }
                     const productId = addToCartBtn.getAttribute('data-product-id');
                     currentCart[productId] = (currentCart[productId] || 0) + 1;
                     updateCartCount();
                     updateUserCartInFirestore();
                     addToCartBtn.innerHTML = '<i class="bi bi-check-lg"></i>';
                     setTimeout(() => {
                          addToCartBtn.innerHTML = '<i class="bi bi-cart-plus"></i>';
                     }, 1000);
                     console.log(`Added ${productId} to cart. New cart:`, currentCart);
                     return; // Hentikan propagasi jika event ditangani
                 }

                 // Tombol Buy Now
                 const buyNowBtn = target.closest('.buy-now-btn');
                 if (buyNowBtn) {
                      if (!currentUser) {
                         alert("Silakan login untuk membeli item.");
                         loadPage('login');
                         return;
                     }
                     const productId = buyNowBtn.getAttribute('data-product-id');
                     currentCart = { [productId]: 1 };
                     updateCartCount();
                     // Tidak perlu update firestore di sini karena langsung checkout
                     loadPage('checkout');
                     console.log(`Buying now: ${productId}`);
                     return;
                 }

                 // Tombol Favorite
                 const favoriteIcon = target.closest('.favorite-icon');
                 if (favoriteIcon) {
                      if (!currentUser) {
                         alert("Silakan login untuk menambahkan item ke favorit.");
                         loadPage('login');
                         return;
                     }
                     const productId = favoriteIcon.getAttribute('data-product-id');
                     const isFavorited = currentFavorites.includes(productId);

                     if (isFavorited) {
                         currentFavorites = currentFavorites.filter(id => id !== productId);
                         favoriteIcon.classList.remove('bi-heart-fill', 'favorited');
                         favoriteIcon.classList.add('bi-heart');
                     } else {
                         currentFavorites.push(productId);
                         favoriteIcon.classList.add('bi-heart-fill', 'favorited');
                         favoriteIcon.classList.remove('bi-heart');
                     }
                     updateUserFavoritesInFirestore();
                     console.log(`Toggled favorite for ${productId}. New favorites:`, currentFavorites);
                     if (window.location.hash === '#favorites' && isFavorited) {
                         loadFavoritesPage();
                     }
                     return;
                 }

                  // Tombol Share
                 const shareBtn = target.closest('.share-btn');
                 if (shareBtn) {
                     const productId = shareBtn.getAttribute('data-product-id');
                     const productName = shareBtn.getAttribute('data-product-name') || 'Produk Keren';
                     const productUrl = `${window.location.origin}${window.location.pathname}#product-detail?id=${productId}`;

                     const shareData = {
                         title: `Lihat ${productName} di BUYDOR!`,
                         text: `Saya menemukan ${productName} di BUYDOR. Cek di sini:`,
                         url: productUrl,
                     };

                     if (navigator.share) {
                          navigator.share(shareData)
                             .then(() => console.log('Produk berhasil dibagikan'))
                             .catch((err) => console.error('Error sharing:', err));
                     } else {
                         alert(`Bagikan tautan ini:\n${shareData.url}`);
                     }
                     return;
                 }
             });


            // Listener untuk Filter Kategori (di luar event delegation karena elemennya berbeda)
            document.querySelectorAll('.category-nav .nav-link').forEach(link => {
                 link.addEventListener('click', async (e) => {
                     e.preventDefault();
                     showLoading();
                     document.querySelectorAll('.category-nav .nav-link').forEach(l => l.classList.remove('active'));
                     e.currentTarget.classList.add('active');

                     const category = e.currentTarget.getAttribute('data-category');
                     console.log(`Filtering by category: ${category}`);

                     let query = db.collection('products');
                     if (category !== 'all') {
                         query = query.where('category', '==', category);
                     }
                     query = query.limit(10);

                     try {
                         const productsSnapshot = await query.get();
                         let productsHtml = '';
                         if (productsSnapshot.empty) {
                             productsHtml = '<div class="col-12"><p>Tidak ada produk dalam kategori ini.</p></div>';
                         } else {
                             productsSnapshot.forEach(doc => {
                                 productsHtml += renderProductCard(doc.id, doc.data()); // Gunakan fungsi render
                             });
                         }
                         const productRow = pageContent.querySelector('.product-list-row'); // Target row produk
                         if (productRow) {
                             productRow.innerHTML = productsHtml;
                             // Tidak perlu attach ulang listener karena pakai event delegation
                         } else {
                              console.error("Product list row not found for filtering.");
                         }
                     } catch (error) {
                         console.error("Error filtering products:", error);
                         alert("Gagal memfilter produk.");
                     } finally {
                         hideLoading();
                     }
                 });
             });
        };

        const addCartEventListeners = () => {
            const cartContainer = pageContent.querySelector('.list-group'); // Target container item keranjang
            if (!cartContainer) return;

            // Event delegation untuk item keranjang
            cartContainer.addEventListener('click', (e) => {
                const target = e.target;

                // Tombol Hapus Item
                const removeBtn = target.closest('.remove-cart-item-btn');
                if (removeBtn) {
                    const cartItemElement = removeBtn.closest('.cart-item');
                    const productId = cartItemElement.getAttribute('data-product-id');
                    delete currentCart[productId];
                    updateCartCount();
                    updateUserCartInFirestore();
                    cartItemElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    cartItemElement.style.opacity = '0';
                    cartItemElement.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        loadCartPage(); // Muat ulang halaman keranjang
                    }, 300);
                    console.log(`Removed ${productId} from cart.`);
                    return;
                }

                // Tombol Ubah Kuantitas
                const quantityBtn = target.closest('.quantity-change-btn');
                if (quantityBtn) {
                    const cartItemElement = quantityBtn.closest('.cart-item');
                    const productId = cartItemElement.getAttribute('data-product-id');
                    const quantityInput = cartItemElement.querySelector('.quantity-input');
                    const change = parseInt(quantityBtn.getAttribute('data-change'), 10);
                    let currentQuantity = parseInt(quantityInput.value, 10);
                    let newQuantity = currentQuantity + change;

                    if (newQuantity < 1) newQuantity = 1;

                    currentCart[productId] = newQuantity;
                    quantityInput.value = newQuantity;
                    updateCartCount();
                    updateUserCartInFirestore();
                    loadCartPage(); // Muat ulang untuk update total
                    console.log(`Changed quantity for ${productId} to ${newQuantity}.`);
                    return;
                }
            });

             // Listener untuk tombol Checkout (di luar delegation)
             const checkoutBtn = document.querySelector('.checkout-btn');
             if (checkoutBtn) {
                 checkoutBtn.addEventListener('click', () => {
                     loadPage('checkout');
                 });
             }
         };

        const addOrdersEventListeners = () => {
            const orderListContainer = pageContent.querySelector('.list-group');
            if (!orderListContainer) return;

            orderListContainer.addEventListener('click', (e) => {
                 const detailsBtn = e.target.closest('.view-order-details-btn');
                 if (detailsBtn) {
                     const orderId = detailsBtn.getAttribute('data-order-id');
                     alert(`Menampilkan detail untuk Pesanan #${orderId} (implementasi modal/halaman baru diperlukan)`);
                     // TODO: Implementasi tampilan detail pesanan (misal, dengan modal Bootstrap)
                 }
            });
        };

        const addAccountEventListeners = () => {
    const accountForm = document.getElementById('account-update-form');
    const profilePicInput = document.getElementById('profile-picture-input');
    const profilePicPreview = document.getElementById('profile-picture-preview');
    const logoutButtonAccount = document.getElementById('logout-button-account');

    if (accountForm) {
        accountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const newName = document.getElementById('account-name').value;
            const newPhone = document.getElementById('account-phone').value;
            const newAddress = document.getElementById('account-address').value;
            const newPassword = document.getElementById('account-password').value;

            try {
                const updates = [];
                const firestoreUpdates = {};

                // Update name
                if (newName !== (currentUser.displayName || '')) {
                    updates.push(currentUser.updateProfile({ displayName: newName }));
                    firestoreUpdates.name = newName;
                }

                // Update phone number
                if (newPhone !== (currentUser.phoneNumber || '')) {
                    firestoreUpdates.phoneNumber = newPhone;
                }

                // Update address
                if (newAddress !== '') {
                    firestoreUpdates.address = newAddress;
                }

                // Update password
                if (newPassword) {
                    if (newPassword.length < 6) {
                        alert("Kata sandi baru minimal harus 6 karakter.");
                        hideLoading();
                        return;
                    }
                    updates.push(currentUser.updatePassword(newPassword));
                }

                // Apply updates
                if (Object.keys(firestoreUpdates).length > 0) {
                    updates.push(db.collection('users').doc(currentUser.uid).update(firestoreUpdates));
                }

                if (updates.length > 0) {
                    await Promise.all(updates);
                    alert("Profil berhasil diperbarui!");
                    if (newPassword) document.getElementById('account-password').value = '';
                } else {
                    alert("Tidak ada perubahan yang disimpan.");
                }

            } catch (error) {
                console.error("Error updating profile:", error);
                if (error.code === 'auth/requires-recent-login') {
                    alert('Gagal memperbarui profil: Operasi ini memerlukan login ulang. Silakan logout dan login kembali.');
                    handleLogout();
                } else if (error.code === 'permission-denied') {
                    alert('Gagal memperbarui profil: Masalah izin akses Firestore. Periksa Aturan Keamanan.');
                } else {
                    alert(`Gagal memperbarui profil: ${error.message}`);
                }
            } finally {
                hideLoading();
            }
        });
    }

    if (profilePicInput && profilePicPreview) {
        profilePicInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                alert("Silakan pilih file gambar.");
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert("Ukuran gambar maksimal 5MB.");
                return;
            }
            showLoading();

            const reader = new FileReader();
            reader.onload = (event) => { profilePicPreview.src = event.target.result; };
            reader.readAsDataURL(file);

            const storageRef = storage.ref(`profile_pictures/${currentUser.uid}/${Date.now()}_${file.name}`);
            try {
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();

                await currentUser.updateProfile({ photoURL: downloadURL });
                await db.collection('users').doc(currentUser.uid).update({ photoURL: downloadURL });

                alert("Foto profil berhasil diperbarui!");
            } catch (error) {
                console.error("Error uploading profile picture:", error);
                if (error.code === 'storage/unauthorized') {
                    alert('Gagal mengunggah foto: Masalah izin akses Firebase Storage. Periksa aturan Storage.');
                } else {
                    alert(`Gagal mengunggah foto profil: ${error.message}`);
                }
                profilePicPreview.src = currentUser.photoURL || 'https://placehold.co/150x150/e9ecef/6c757d?text=Profil';
            } finally {
                hideLoading();
            }
        });
    }

    if (logoutButtonAccount) {
        logoutButtonAccount.addEventListener('click', handleLogout);
    }
};

         const addCheckoutEventListeners = () => {
    const stepsContainer = document.getElementById('checkout-steps');
    if (!stepsContainer) return;

    let shippingData = {};
    let paymentData = {};

    // Toggle payment forms
    const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
    const paymentForms = {
        'cc': document.getElementById('cc-form'),
        'bank': document.getElementById('bank-form'),
        'wallet': document.getElementById('wallet-form')
    };

    paymentRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            Object.values(paymentForms).forEach(form => form.classList.add('d-none'));
            paymentForms[e.target.value].classList.remove('d-none');
        });
    });

    stepsContainer.addEventListener('click', async (e) => {
        const target = e.target;

        // Tombol Next Step
        const nextBtn = target.closest('.next-step-btn');
        if (nextBtn) {
            const currentStep = nextBtn.closest('.checkout-step');
            const nextStepId = nextBtn.getAttribute('data-next');
            const nextStep = document.getElementById(nextStepId);

            const form = currentStep.querySelector('form');
            if (form) {
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                if (currentStep.id === 'step-shipping') {
                    shippingData = {
                        name: document.getElementById('shipping-name').value,
                        address: document.getElementById('shipping-address').value,
                        phone: document.getElementById('shipping-phone').value,
                    };
                    console.log("Shipping data saved:", shippingData);
                }
            }

            if (currentStep && nextStep) {
                currentStep.classList.remove('active');
                nextStep.classList.add('active');
            }
            return;
        }

        // Tombol Prev Step
        const prevBtn = target.closest('.prev-step-btn');
        if (prevBtn) {
            const currentStep = prevBtn.closest('.checkout-step');
            const prevStepId = prevBtn.getAttribute('data-prev');
            const prevStep = document.getElementById(prevStepId);
            if (currentStep && prevStep) {
                currentStep.classList.remove('active');
                prevStep.classList.add('active');
            }
            return;
        }

        // Tombol Place Order
        const placeOrderBtn = target.closest('.place-order-btn');
        if (placeOrderBtn) {
            showLoading();
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
            let paymentForm;
            if (paymentMethod === 'cc') paymentForm = document.getElementById('credit-card-form');
            else if (paymentMethod === 'bank') paymentForm = document.getElementById('bank-transfer-form');
            else if (paymentMethod === 'wallet') paymentForm = document.getElementById('digital-wallet-form');

            if (paymentForm && !paymentForm.checkValidity()) {
                paymentForm.reportValidity();
                hideLoading();
                return;
            }

            // Collect payment data
            if (paymentMethod === 'cc') {
                paymentData = {
                    method: 'Credit Card',
                    cardNumber: document.getElementById('cc-number').value.replace(/\s/g, '').slice(-4), // Last 4 digits for mock
                    cardHolder: document.getElementById('cc-name').value,
                    expiry: document.getElementById('cc-expiry').value,
                };
            } else if (paymentMethod === 'bank') {
                paymentData = {
                    method: 'Bank Transfer',
                    bank: document.getElementById('bank-select').value,
                };
            } else if (paymentMethod === 'wallet') {
                paymentData = {
                    method: 'Digital Wallet',
                    wallet: document.getElementById('wallet-select').value,
                    phone: document.getElementById('wallet-phone').value,
                };
            }

            let orderItems = [];
            let calculatedTotalPrice = 0;
            const productIds = Object.keys(currentCart);
            if (productIds.length === 0) {
                alert("Keranjang kosong. Tidak dapat membuat pesanan.");
                hideLoading();
                loadPage('dashboard');
                return;
            }
            const productPromises = productIds.map(id => db.collection('products').doc(id).get());

            try {
                const productDocs = await Promise.all(productPromises);
                productDocs.forEach(doc => {
                    if (doc.exists) {
                        const product = doc.data();
                        const productId = doc.id;
                        const quantity = currentCart[productId];
                        if (quantity && quantity > 0) {
                            orderItems.push({
                                productId: productId,
                                name: product.name,
                                price: product.price,
                                quantity: quantity,
                                imageUrl: product.imageUrl || null
                            });
                            calculatedTotalPrice += (product.price || 0) * quantity;
                        }
                    }
                });

                if (orderItems.length === 0) {
                    alert("Gagal mendapatkan detail produk untuk keranjang Anda. Coba lagi.");
                    hideLoading();
                    loadPage('cart');
                    return;
                }

                const orderData = {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || shippingData.name || 'N/A',
                    items: orderItems,
                    totalPrice: calculatedTotalPrice,
                    shippingInfo: shippingData,
                    paymentMethod: paymentData.method,
                    paymentDetails: paymentData,
                    status: 'Dalam Proses',
                    orderDate: firebase.firestore.FieldValue.serverTimestamp()
                };

                const orderRef = await db.collection('orders').add(orderData);
                console.log("Order placed successfully with ID:", orderRef.id);

                currentCart = {};
                updateCartCount();
                await updateUserCartInFirestore();

                document.getElementById('confirmation-order-id').textContent = orderRef.id;
                document.getElementById('step-payment').classList.remove('active');
                document.getElementById('step-confirmation').classList.add('active');

            } catch (error) {
                console.error("Error placing order:", error);
                if (error.code === 'permission-denied') {
                    alert(`Gagal membuat pesanan: Masalah izin akses Firestore. Pastikan Aturan Keamanan mengizinkan pembuatan pesanan.`);
                } else {
                    alert(`Gagal membuat pesanan: ${error.message}`);
                }
            } finally {
                hideLoading();
            }
            return;
        }
    });

    const shippingForm = document.getElementById('shipping-form');
    if (shippingForm) {
        shippingForm.addEventListener('submit', (e) => {
            e.preventDefault();
        });
    }

    // Input formatting for credit card
    const ccNumberInput = document.getElementById('cc-number');
    if (ccNumberInput) {
        ccNumberInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            value = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = value;
        });
    }
};

        const addSearchFunctionality = () => {
             if (searchInputDesktop) {
                 let searchTimeout;
                 searchInputDesktop.addEventListener('input', (e) => {
                     clearTimeout(searchTimeout); // Hapus timeout sebelumnya
                     const query = e.target.value.trim().toLowerCase();

                     if (query.length < 2) {
                         searchResultsDesktop.innerHTML = '';
                         searchResultsDesktop.classList.add('d-none');
                         return;
                     }

                     // Tunda pencarian sedikit untuk menghindari query berlebihan saat mengetik cepat
                     searchTimeout = setTimeout(async () => {
                         searchResultsDesktop.classList.remove('d-none');
                         searchResultsDesktop.innerHTML = '<div class="list-group-item disabled">Mencari...</div>';

                         try {
                             // Implementasi pencarian yang lebih baik (misal, menggunakan fungsi search jika ada, atau Algolia)
                             // Query sederhana berdasarkan nama (case-insensitive di client-side)
                             const productsSnapshot = await db.collection('products')
                                                         .orderBy('name')
                                                         .limit(20) // Ambil lebih banyak, filter di client
                                                         .get();

                             searchResultsDesktop.innerHTML = ''; // Kosongkan hasil
                             let found = 0;
                             productsSnapshot.forEach(doc => {
                                 const product = doc.data();
                                 if (product.name.toLowerCase().includes(query) && found < 5) { // Batasi hasil di client
                                     found++;
                                     const item = document.createElement('a');
                                     item.href = `#product-detail?id=${doc.id}`;
                                     item.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'align-items-center');
                                     item.innerHTML = `
                                         <img src="${product.imageUrl || 'https://placehold.co/40x40/e9ecef/6c757d?text=P'}" alt="${product.name}" width="40" class="me-2 rounded">
                                         <span>${product.name}</span>
                                         <small class="ms-auto text-muted">Rp ${product.price?.toLocaleString('id-ID')}</small>
                                     `;
                                     item.addEventListener('click', (ev) => {
                                         ev.preventDefault();
                                         alert(`Navigasi ke detail produk: ${product.name} (implementasi diperlukan)`);
                                         searchResultsDesktop.classList.add('d-none');
                                         searchInputDesktop.value = '';
                                         // loadPage('product-detail', { productId: doc.id });
                                     });
                                     searchResultsDesktop.appendChild(item);
                                 }
                             });

                             if (found === 0) {
                                 searchResultsDesktop.innerHTML = '<div class="list-group-item disabled">Produk tidak ditemukan.</div>';
                             }
                         } catch (error) {
                             console.error("Error searching products:", error);
                             searchResultsDesktop.innerHTML = '<div class="list-group-item text-danger">Gagal melakukan pencarian.</div>';
                         }
                     }, 300); // Delay 300ms
                 });

                 document.addEventListener('click', (e) => {
                     if (!searchResultsDesktop.contains(e.target) && e.target !== searchInputDesktop) {
                         searchResultsDesktop.classList.add('d-none');
                     }
                 });
             }
         };

        const handleLogout = async () => { // Pisahkan fungsi logout
             showLoading();
             try {
                 await auth.signOut();
                 console.log("User logged out");
                 // onAuthStateChanged akan menangani reset state dan navigasi
             } catch (error) {
                 console.error("Logout Error:", error);
                 alert(`Gagal logout: ${error.message}`);
                 hideLoading(); // Sembunyikan loading jika logout gagal
             }
         };

        const addLogoutFunctionality = () => {
             if (logoutButtonSidebar) {
                 logoutButtonSidebar.addEventListener('click', handleLogout);
             }
             // Listener logout di halaman akun sudah di addAccountEventListeners
         };

         const loadCheckoutCartSummary = async () => {
             const summaryElement = document.getElementById('checkout-cart-summary');
             if (!summaryElement) return;

             summaryElement.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Memuat...</span></div></div>';
             let summaryHtml = '<ul class="list-group list-group-flush">';
             let checkoutTotalPrice = 0;
             const productIds = Object.keys(currentCart);
              // Pastikan ada item di keranjang
             if (productIds.length === 0) {
                 summaryElement.innerHTML = '<p class="text-muted">Keranjang kosong.</p>';
                 // Mungkin nonaktifkan tombol lanjut?
                 document.querySelector('#step-review .next-step-btn')?.setAttribute('disabled', true);
                 return;
             }
             const productPromises = productIds.map(id => db.collection('products').doc(id).get());

             try {
                 const productDocs = await Promise.all(productPromises);
                 let validItems = 0;
                 productDocs.forEach(doc => {
                     if (doc.exists) {
                         const product = doc.data();
                         const productId = doc.id;
                         const quantity = currentCart[productId];
                         if (quantity && quantity > 0) { // Pastikan quantity valid
                             validItems++;
                             const itemTotal = (product.price || 0) * quantity;
                             checkoutTotalPrice += itemTotal;
                             summaryHtml += `
                                 <li class="list-group-item d-flex justify-content-between align-items-center">
                                     <div>
                                         <img src="${product.imageUrl || 'https://placehold.co/50x50/e9ecef/6c757d?text=P'}" alt="${product.name}" width="50" class="me-2 rounded float-start">
                                         ${product.name} <span class="text-muted">x ${quantity}</span>
                                     </div>
                                     <span class="badge bg-light text-dark rounded-pill">Rp ${itemTotal.toLocaleString('id-ID')}</span>
                                 </li>`;
                         }
                     }
                 });

                 // Jika tidak ada item valid setelah cek
                 if (validItems === 0) {
                      summaryElement.innerHTML = '<p class="text-muted">Keranjang kosong atau produk tidak valid.</p>';
                      document.querySelector('#step-review .next-step-btn')?.setAttribute('disabled', true);
                      return;
                 }


                 summaryHtml += `
                     <li class="list-group-item d-flex justify-content-between align-items-center fw-bold fs-5 mt-2">
                         Total
                         <span>Rp ${checkoutTotalPrice.toLocaleString('id-ID')}</span>
                     </li>`;
                 summaryHtml += '</ul>';
                 summaryElement.innerHTML = summaryHtml;
                 document.querySelector('#step-review .next-step-btn')?.removeAttribute('disabled'); // Aktifkan tombol jika ada item
             } catch (error) {
                 console.error("Error loading checkout summary:", error);
                 summaryElement.innerHTML = '<p class="text-danger">Gagal memuat ringkasan keranjang.</p>';
                 document.querySelector('#step-review .next-step-btn')?.setAttribute('disabled', true); // Nonaktifkan tombol jika error
             }
         };

        // --- Authentication State Listener ---
        auth.onAuthStateChanged(async (user) => {
            console.log("Auth state changed. User:", user ? user.uid : 'null');
            showLoading();
            if (user) {
                currentUser = user;
                if(logoutButtonSidebar) logoutButtonSidebar.classList.remove('d-none');
                await fetchUserData(user.uid); // fetchUserData akan memanggil loadPage jika perlu atau hideLoading
            } else {
                currentUser = null;
                currentCart = {};
                currentFavorites = [];
                updateCartCount();
                if(logoutButtonSidebar) logoutButtonSidebar.classList.add('d-none');
                loadPage('login'); // loadLoginPage akan memanggil hideLoading
            }
        });


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded");
            addNavigationListeners();
            addSearchFunctionality();
            addLogoutFunctionality();
            // Pemuatan halaman awal ditangani oleh onAuthStateChanged
        });

    </script>
</body>
</html>
